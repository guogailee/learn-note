## 中间件

- Sharding-jdbc：client层方案轻便，维护成本低。
- mycat：proxy层方案。

## 分库分表

- 水平拆分

  ```
  把一个表的数据弄到多个库的多个表，每个库的表结构都一样。
  
  把数据均匀放更多的库，目的是为了抗更高的并发，抗更高的容量需求
  ```

- 垂直拆分

  ```
  把一个有很多字段的表拆分为多个表。
  
  比如订单大表：
  拆分为 订单表 订单明细 订单支付表 订单商品表
  存在在我们的日常开发中
  ```

- 方式

  ```
  1.按照某个字段hash
  这种方式比较平均
  
  2.按照range分
  容易产生热点问题，大量的流量打在最新的数据上
  ```

## 实战分库分表的过程

- 把单表600万的数据》拆分到3个库，每个库3张表，每张表存50万数据

  - 停机迁移方案

    ```
    先停机，然后导数据，然后启动应用。
    ```

  - 双写迁移方案

    ```
    同时写旧库和新库，然后部署，不停机，做数据迁移，反复直到数据完全一致。
    ```

## 设计可以动态扩容缩的分库分表

- 之前的4个库，每个库3张表，支撑不住了，需要继续扩容。

- 数据迁移

  - 停机扩容：不行，之前12张表，上亿的数据，导数据就要好几个小时，还要回归验证，来不及。

- 如何做呢

  ```
  一开始就32个库，每个库32张表=1024张表
  
  orderId%32 求落入哪个库
  orderId/32%32 求落入哪个表
  
  刚开始是逻辑的1024都在一个数据库服务器上，随着压力变更，改成物理上的数据库服务器。修改配置重启服务器。让DBA做整表的迁移就行。
  
  比如：
  订单号259 %3=3 /3%3=8
  
  ```
