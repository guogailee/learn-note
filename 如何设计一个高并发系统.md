## 如何设计一个高并发系统？

## 一定是结合业务去设计的

并发：同一时刻有多少个请求在跑

为何需要设计高并发系统？

```
单机数据库支撑到每秒并发两三千的时候，基本就快完了。如果瞬间承载每秒5000，8000，甚至上万的并发，一定会宕机。
```

如何设计？从请求最开始到最底层依次设计

### 系统拆分

```
子系统分布式部署，系统间调用使用dubbo，子系统使用单独的数据库。
```

### 引入缓存

```
大部分高并发的场景，都是读多写少，读的时候走缓存，redis轻轻松松单机几万的并发，所以考虑项目中，承载主要请求的读场景，怎么用缓存来抗高并发。
```

### 引入mq消息队列异步写

```
仍旧有高并发写场景，如何设计呢？比如淘宝双11下单，mq单机抗几万并发。大量的写请求放入mq，排队慢慢玩，后边系统消费后慢慢写，控制在mysql承载范围内。

为何不用redis承载写，redis是缓存，数据随时被LRU，数据格式无比简单，没有事务支持。
```

### 分库分表

```
可能到了数据库层面，还是达不到抗高并发的要求。那么就数据库拆分为多个库，一个表拆分为多个表，比如订单轨迹拆分为N个表，根据订单号hash求在哪个表。

 表的数据量越小，sql性能越高
```

### 数据库读写分离

```
大多数都是读多写少，所以数据库读写分离，读可以搞多个从库。
```

### 引入ElasticSearch

```
ES是分布式的，可以随便扩容，解决高并发。
所以一些简单的查询，统计，全文搜索，可以考虑用ES。
```

## 微信红包高并发架构

### 背景

```
峰值-76万 qps
```

### 库存扣减方案

**一、使用内存操作替代实时的DB事务操作**

```
将“实时扣库存”的行为上移到内存 Cache 中操作，内存 Cache 操作成功直接给 Server 返回成功，然后异步落 DB 持久化。

优点：是用内存操作替代磁盘操作，提高了并发性能。

缺点：在内存操作成功但 DB 持久化失败，或者内存 Cache 故障的情况下，DB 持久化会丢数据。
```

**二、使用乐观锁替代悲观锁**

```
如果应用于微信红包系统，则会存在下面三个问题：

1.如果拆红包采用乐观锁，那么在并发抢到相同版本号的拆红包请求中，只有一个能拆红包成功，其他的请求将事务回滚并返回失败，给用户报错，用户体验完全不可接受。

2.如果采用乐观锁，将会导致第一时间同时拆红包的用户有一部分直接返回失败，反而那些“手慢”的用户，有可能因为并发减小后拆红包成功，这会带来用户体验上的负面影响。

如果采用乐观锁的方式，会带来大数量的无效更新请求、事务回滚，给 DB 造成不必要的额外压力。
```

### 微信红包设计方案

```
主要采用了 SET 化分治、请求排队、双维度分库表等方案，使得单组 DB 的并发性能提升了 8 倍左右，取得了很好的效果。
```

**SET化分治**

```
同个红包 ID 的所有请求，按红包 ID stick 到同个 SET 中。不过在同个 SET 中，会存在多台 Server 服务器同时连接同一台 DB（基于容灾、性能考虑，需要多台 Server 互备、均衡压力）。

为了使同一个红包 ID 的所有请求，stick 到同一台 Server 服务器上，在 SET 化的设计之外，微信红包系统添加了一层基于红包 ID hash 值的分流

将同一个红包 ID 的所有请求 stick 到同一台 Server。
```

**请求排队**

```
将 stick 到同一台 Server 上的所有请求在被接收进程接收后，按红包 ID 进行排队。然后串行地进入 worker 进程（执行业务逻辑）进行处理，从而达到排队的效果

为了防止 Server 中的请求队列过载导致队列被降级，从而所有请求拥进 DB，系统增加了与 Server 服务器同机部署的 memcached，用于控制拆同一个红包的请求并发数。

具体来说，利用 memcached 的 CAS 原子累增操作，控制同时进入 DB 执行拆红包事务的请求数，超过预先设定数值则直接拒绝服务。用于 DB 负载升高时的降级体验。
```

**双维度分库表**

```
初期是根据红包 ID 的 hash 值分为多库多表。随着红包数据量逐渐增大，单表数据量也逐渐增加。而 DB 的性能与单表数据量有一定相关性。当单表数据量达到一定程度时，DB 性能会有大幅度下降，影响系统性能稳定性。采用冷热分离，将历史冷数据与当前热数据分开存储，可以解决这个问题。

系统在以红包 ID 维度分库表的基础上，增加了以循环天分表的维度，形成了双维度分库表的特色。

具体来说，就是分库表规则像 db_xx.t_y_dd 设计，其中，xx/y 是红包 ID 的 hash 值后三位，dd 的取值范围在 01~31，代表一个月天数最多 31 天。
```

