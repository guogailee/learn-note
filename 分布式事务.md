## 分布式事务场景

```
开启分布式事务
1.插入员工数据
2.插入财务数据
3.插入请假数据
提交分布式事务/回滚
```

## 分布式事务方案

### 两阶段提交方案

**过程**

```
第一阶段：事务管理器询问事务参与者是否可以执行
第二阶段：事务参与者执行
```

**应用场景**

```

```

## TCC方案-同步调用方案

 **过程**

```
Try：对各个服务的资源进行检测以及对资源进行锁定
Confirm：在各个服务中执行实际的操作
Cancel：如果任何一个业务方法执行出错，回滚已经执行成功的
```

**应用场景**

```
1.支付/交易严格要求的场景
(车辆交易，锁车成功，下单失败，异常单系统解锁库存是某种意义上TCC)
```

**缺点**

```
1.依赖自己写回滚代码，回滚代码巨大，每个业务回滚逻辑不一样
```

## 可靠消息最终一致性方案-异步调用，最终一致性方案

**过程**

```
RocketMQ：基于两阶段提交+事务状态回查实现
```

**应用场景**

```
结合RocketMQ就可以，可以用在大多数分布式系统中，资金系统用TCC。
```

### 高可用

```
MQ高可用集群如果挂了，提供备选方案。自行封装MQ客户端组件与故障感知，基于KV存储队列的降级方案

redis的list类型支持消息队列，双向链表，lpush rpop
```

## 经验

```
1.99%的分布式接口调用，不要做分布式事务，直接监控发邮件，打印日志，数据订正，成本比上分布式事务低很多

2.分布式事务带来系统复杂性增加，性能下降

3.做权衡

4.一般对资金、交易做分布式事务，100%保证不出错
```

